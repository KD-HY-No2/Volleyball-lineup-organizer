<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volleyball Lineup Optimizer</title>
    <meta name="description" content="Professional volleyball lineup optimization with star player management">
    <meta name="theme-color" content="#8b5cf6">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Volleyball Optimizer">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        @media (max-width: 768px) {
            html, body {
                height: 100%;
                overflow-x: hidden;
            }
        }

        ::-webkit-scrollbar {
            width: 3px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .drop-zone-active {
            background-color: rgba(59, 130, 246, 0.1) !important;
            border: 2px dashed #3b82f6 !important;
        }

        .optimizing {
            background: linear-gradient(45deg, #8b5cf6, #a855f7);
            animation: pulse 2s infinite;
        }

        .star-player {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            border-color: #ffd700 !important;
        }

        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const VolleyballApp = () => {
            // PWA Install State
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);

            // Load data from localStorage on startup
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch (error) {
                    console.warn(`Error loading ${key} from storage:`, error);
                    return defaultValue;
                }
            };

            // Save data to localStorage
            const saveToStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.warn(`Error saving ${key} to storage:`, error);
                }
            };

            // Initialize with saved data or defaults
            const [players, setPlayers] = useState(() => loadFromStorage('volleyball_players', [
                { id: 1, name: '1', defense: 3, serving: 3, active: true, star: false },
                { id: 2, name: '2', defense: 3, serving: 3, active: true, star: false },
                { id: 3, name: '3', defense: 3, serving: 3, active: true, star: false },
                { id: 4, name: '4', defense: 3, serving: 3, active: true, star: false },
                { id: 5, name: '5', defense: 3, serving: 3, active: true, star: false },
                { id: 6, name: '6', defense: 3, serving: 3, active: true, star: false },
                { id: 7, name: '7', defense: 3, serving: 3, active: true, star: false },
                { id: 8, name: '8', defense: 3, serving: 3, active: true, star: false },
                { id: 9, name: '9', defense: 3, serving: 3, active: true, star: false },
                { id: 10, name: '10', defense: 3, serving: 3, active: true, star: false }
            ]));

            const [showPlayerForm, setShowPlayerForm] = useState(false);
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [teamName, setTeamName] = useState(() => loadFromStorage('volleyball_teamName', 'My Team'));
            const [minThreshold, setMinThreshold] = useState(() => loadFromStorage('volleyball_minThreshold', 6));
            const [isOptimizing, setIsOptimizing] = useState(false);
            const [draggedPlayer, setDraggedPlayer] = useState(null);
            const [dropZone, setDropZone] = useState(null);
            const [bestLineups, setBestLineups] = useState([]);
            const [currentLineupIndex, setCurrentLineupIndex] = useState(0);

            // Form state
            const [playerForm, setPlayerForm] = useState({
                name: '',
                defense: 3,
                serving: 3,
                active: true,
                star: false
            });

            // Court positions (6 on court, rest on bench)
            const [courtPositions, setCourtPositions] = useState(() => 
                loadFromStorage('volleyball_courtPositions', {
                    backLeft: null,
                    frontLeft: null,
                    frontMiddle: null,
                    frontRight: null,
                    backRight: null,
                    backMiddle: null,
                    bench: []
                })
            );

            // Save to localStorage whenever data changes
            useEffect(() => {
                saveToStorage('volleyball_players', players);
            }, [players]);

            useEffect(() => {
                saveToStorage('volleyball_teamName', teamName);
            }, [teamName]);

            useEffect(() => {
                saveToStorage('volleyball_minThreshold', minThreshold);
            }, [minThreshold]);

            useEffect(() => {
                saveToStorage('volleyball_courtPositions', courtPositions);
            }, [courtPositions]);

            // PWA Install Prompt Handling
            useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowInstallPrompt(true);
                };

                const handleAppInstalled = () => {
                    setShowInstallPrompt(false);
                    setDeferredPrompt(null);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.addEventListener('appinstalled', handleAppInstalled);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                    window.removeEventListener('appinstalled', handleAppInstalled);
                };
            }, []);

            // Register Service Worker
            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                }
            }, []);

            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        setShowInstallPrompt(false);
                    }
                    setDeferredPrompt(null);
                }
            };

            const handleAddPlayer = () => {
                if (playerForm.name.trim()) {
                    const newPlayer = {
                        id: Date.now(),
                        ...playerForm
                    };
                    setPlayers([...players, newPlayer]);
                    setPlayerForm({ name: '', defense: 3, serving: 3, active: true, star: false });
                    setShowPlayerForm(false);
                }
            };
const handleEditPlayer = (player) => {
                if (draggedPlayer) return;
                setEditingPlayer(player.id);
                setPlayerForm(player);
                setShowPlayerForm(true);
            };

            const handleUpdatePlayer = () => {
                setPlayers(players.map(p => 
                    p.id === editingPlayer ? { ...playerForm, id: editingPlayer } : p
                ));
                setEditingPlayer(null);
                setPlayerForm({ name: '', defense: 3, serving: 3, active: true, star: false });
                setShowPlayerForm(false);
            };

            const togglePlayerActive = (id) => {
                setPlayers(players.map(p => 
                    p.id === id ? { ...p, active: !p.active } : p
                ));
            };

            const togglePlayerStar = (id) => {
                const currentStars = players.filter(p => p.star).length;
                const targetPlayer = players.find(p => p.id === id);
                
                if (!targetPlayer.star && currentStars >= 3) {
                    return;
                }
                
                setPlayers(players.map(p => 
                    p.id === id ? { ...p, star: !p.star } : p
                ));
            };

            const checkStarRules = (positions) => {
                const courtPlayers = [
                    positions.backLeft,
                    positions.frontLeft,
                    positions.frontMiddle,
                    positions.frontRight,
                    positions.backRight,
                    positions.backMiddle
                ].filter(Boolean);

                const starsOnCourt = courtPlayers.filter(p => p.star).length;
                
                if (starsOnCourt === 0) return false;

                const starPositions = [];
                if (positions.backLeft?.star) starPositions.push(1);
                if (positions.frontLeft?.star) starPositions.push(2);
                if (positions.frontMiddle?.star) starPositions.push(3);
                if (positions.frontRight?.star) starPositions.push(4);
                if (positions.backRight?.star) starPositions.push(5);
                if (positions.backMiddle?.star) starPositions.push(6);

                for (let i = 0; i < starPositions.length; i++) {
                    for (let j = i + 1; j < starPositions.length; j++) {
                        const pos1 = starPositions[i];
                        const pos2 = starPositions[j];
                        
                        if (Math.abs(pos1 - pos2) === 1 || (pos1 === 1 && pos2 === 6) || (pos1 === 6 && pos2 === 1)) {
                            return false;
                        }
                    }
                }

                return true;
            };

            const calculateRotationStrengths = (positions) => {
                const rotations = [];
                let currentPositions = { ...positions };
                
                for (let i = 0; i < 10; i++) {
                    const frontRowTotal = (currentPositions.frontLeft?.defense || 0) + 
                                         (currentPositions.frontMiddle?.defense || 0) + 
                                         (currentPositions.frontRight?.defense || 0);
                    const backRowTotal = (currentPositions.backLeft?.defense || 0) + 
                                        (currentPositions.backMiddle?.defense || 0) + 
                                        (currentPositions.backRight?.defense || 0);
                    
                    rotations.push({
                        frontRowTotal,
                        backRowTotal,
                        serverRating: currentPositions.backLeft?.serving || 0,
                        rotation: i
                    });
                    
                    const newPositions = {
                        backRight: currentPositions.backMiddle,
                        frontRight: currentPositions.backRight,
                        frontMiddle: currentPositions.frontRight,
                        frontLeft: currentPositions.frontMiddle,
                        backLeft: currentPositions.frontLeft,
                        bench: [...currentPositions.bench]
                    };
                    
                    const newBench = [...currentPositions.bench];
                    if (newBench.length > 0) {
                        newBench.push(currentPositions.backLeft);
                        newPositions.backMiddle = newBench.shift();
                    } else {
                        newPositions.backMiddle = currentPositions.backLeft;
                    }
                    newPositions.bench = newBench;
                    
                    currentPositions = newPositions;
                }
                
                return rotations;
            };

            const optimizeStandardPlay = async () => {
                setIsOptimizing(true);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const activePlayers = players.filter(p => p.active);
                const starPlayers = activePlayers.filter(p => p.star);
                
                if (activePlayers.length < 6) {
                    setIsOptimizing(false);
                    return;
                }

                if (starPlayers.length === 0) {
                    alert("Please select at least 1 star player to use optimization.");
                    setIsOptimizing(false);
                    return;
                }

                const sortedByDefense = [...activePlayers].sort((a, b) => b.defense - a.defense);
                const top3Defenders = sortedByDefense.slice(0, 3);

                let allLineups = [];

                const combinations = [];
                const generateCombinations = (arr, size, start = 0, current = []) => {
                    if (current.length === size) {
                        combinations.push([...current]);
                        return;
                    }
                    for (let i = start; i < arr.length; i++) {
                        current.push(arr[i]);
                        generateCombinations(arr, size, i + 1, current);
                        current.pop();
                    }
                };
                
                generateCombinations(activePlayers, 6);

                const validCombinations = combinations.filter(combo => 
                    combo.some(player => player.star)
                );

                for (const combo of validCombinations) {
                    const permutations = [];
                    const generatePermutations = (arr, current = []) => {
                        if (current.length === arr.length) {
                            permutations.push([...current]);
                            return;
                        }
                        for (let i = 0; i < arr.length; i++) {
                            if (!current.includes(arr[i])) {
                                current.push(arr[i]);
                                generatePermutations(arr, current);
                                current.pop();
                            }
                        }
                    };
                    
                    generatePermutations(combo);

                    for (const perm of permutations) {
                        const testPositions = {
                            backLeft: perm[0],
                            frontLeft: perm[1],
                            frontMiddle: perm[2],
                            frontRight: perm[3],
                            backRight: perm[4],
                            backMiddle: perm[5],
                            bench: activePlayers.filter(p => !combo.includes(p))
                        };

                        if (!checkStarRules(testPositions)) continue;

                        const rotations = calculateRotationStrengths(testPositions);
                        
                        let aboveThresholdCount = 0;
                        let totalDefense = 0;
                        let servingScore = 0;
                        let topDefenderInBackCount = 0;
                        let starBonus = 0;

                        rotations.forEach((rotation, index) => {
                            if (rotation.frontRowTotal >= minThreshold && rotation.backRowTotal >= minThreshold) {
                                aboveThresholdCount++;
                            }
                            totalDefense += rotation.frontRowTotal + rotation.backRowTotal;
                            
                            const rotationWeight = Math.max(1, 10 - index);
                            servingScore += rotation.serverRating * rotationWeight;

                            let currentPos = { ...testPositions };
                            for (let r = 0; r < index; r++) {
                                const newPos = {
                                    backRight: currentPos.backMiddle,
                                    frontRight: currentPos.backRight,
                                    frontMiddle: currentPos.frontRight,
                                    frontLeft: currentPos.frontMiddle,
                                    backLeft: currentPos.frontLeft,
                                    bench: [...currentPos.bench]
                                };
                                const newBench = [...currentPos.bench];
                                if (newBench.length > 0) {
                                    newBench.push(currentPos.backLeft);
                                    newPos.backMiddle = newBench.shift();
                                } else {
                                    newPos.backMiddle = currentPos.backLeft;
                                }
                                newPos.bench = newBench;
                                currentPos = newPos;
                            }
                            
                            const rotBackRowPlayers = [currentPos.backLeft, currentPos.backMiddle, currentPos.backRight];
                            if (rotBackRowPlayers.some(player => 
                                player && top3Defenders.some(topDef => topDef.id === player.id)
                            )) {
                                topDefenderInBackCount++;
                            }

                            const courtPlayers = [currentPos.backLeft, currentPos.frontLeft, currentPos.frontMiddle, 
                                                currentPos.frontRight, currentPos.backRight, currentPos.backMiddle];
                            const starsOnCourt = courtPlayers.filter(p => p && p.star).length;
                            if (starsOnCourt >= 2) starBonus += 5;
                        });

                        const avgDefense = totalDefense / rotations.length;
                        const thresholdPercent = aboveThresholdCount / rotations.length;
                        const topDefenderPercent = topDefenderInBackCount / rotations.length;
                        
                        const score = (topDefenderPercent * 150) + (thresholdPercent * 100) + (avgDefense * 2) + (servingScore * 0.1) + starBonus;

                        allLineups.push({
                            positions: testPositions,
                            score: score,
                            thresholdPercent: thresholdPercent,
                            avgDefense: avgDefense,
                            topDefenderPercent: topDefenderPercent,
                            starBonus: starBonus
                        });
                    }

                    if (validCombinations.indexOf(combo) > 500) break;
                }

                allLineups.sort((a, b) => b.score - a.score);
                const topLineups = allLineups.slice(0, 10);
                
                setBestLineups(topLineups);
                setCurrentLineupIndex(0);

                if (topLineups.length > 0) {
                    setCourtPositions(topLineups[0].positions);
                }
                
                setIsOptimizing(false);
            };
const optimizeServingPriority = async () => {
                setIsOptimizing(true);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const activePlayers = players.filter(p => p.active);
                const starPlayers = activePlayers.filter(p => p.star);
                
                if (activePlayers.length < 6) {
                    setIsOptimizing(false);
                    return;
                }

                if (starPlayers.length === 0) {
                    alert("Please select at least 1 star player to use optimization.");
                    setIsOptimizing(false);
                    return;
                }

                let eligibleServers = starPlayers.filter(p => p.serving >= 3);
                if (eligibleServers.length === 0) {
                    eligibleServers = activePlayers.filter(p => p.serving >= 3);
                }
                if (eligibleServers.length === 0) {
                    eligibleServers = [...starPlayers].sort((a, b) => b.serving - a.serving).slice(0, 1);
                }
                
                const firstServer = eligibleServers.sort((a, b) => a.defense - b.defense)[0];
                const remainingPlayers = activePlayers.filter(p => p.id !== firstServer.id);
                const topServers = remainingPlayers.sort((a, b) => b.serving - a.serving).slice(0, 5);
                const benchPlayers = remainingPlayers.filter(p => !topServers.some(ts => ts.id === p.id))
                    .sort((a, b) => b.defense - a.defense);

                let allLineups = [];

                const generatePermutations = (arr, current = []) => {
                    if (current.length === arr.length) {
                        return [current];
                    }
                    const perms = [];
                    for (let i = 0; i < arr.length; i++) {
                        if (!current.includes(arr[i])) {
                            const newCurrent = [...current, arr[i]];
                            perms.push(...generatePermutations(arr, newCurrent));
                        }
                    }
                    return perms;
                };

                const serverPermutations = generatePermutations(topServers);

                for (const perm of serverPermutations) {
                    const testPositions = {
                        backLeft: firstServer,
                        frontLeft: perm[0],
                        frontMiddle: perm[1],
                        frontRight: perm[2],
                        backRight: perm[3],
                        backMiddle: perm[4],
                        bench: benchPlayers
                    };

                    if (!checkStarRules(testPositions)) continue;

                    const rotations = calculateRotationStrengths(testPositions);
                    
                    let aboveThresholdCount = 0;
                    let totalDefense = 0;
                    let servingScore = 0;
                    let starBonus = 0;

                    rotations.forEach((rotation, index) => {
                        if (rotation.frontRowTotal >= minThreshold && rotation.backRowTotal >= minThreshold) {
                            aboveThresholdCount++;
                        }
                        totalDefense += rotation.frontRowTotal + rotation.backRowTotal;
                        
                        const rotationWeight = Math.max(1, 20 - (index * 2));
                        servingScore += rotation.serverRating * rotationWeight;

                        let currentPos = { ...testPositions };
                        for (let r = 0; r < index; r++) {
                            const newPos = {
                                backRight: currentPos.backMiddle,
                                frontRight: currentPos.backRight,
                                frontMiddle: currentPos.frontRight,
                                frontLeft: currentPos.frontMiddle,
                                backLeft: currentPos.frontLeft,
                                bench: [...currentPos.bench]
                            };
                            const newBench = [...currentPos.bench];
                            if (newBench.length > 0) {
                                newBench.push(currentPos.backLeft);
                                newPos.backMiddle = newBench.shift();
                            } else {
                                newPos.backMiddle = currentPos.backLeft;
                            }
                            newPos.bench = newBench;
                            currentPos = newPos;
                        }

                        const courtPlayers = [currentPos.backLeft, currentPos.frontLeft, currentPos.frontMiddle,
                                            currentPos.frontRight, currentPos.backRight, currentPos.backMiddle];
                        const starsOnCourt = courtPlayers.filter(p => p && p.star).length;
                        if (starsOnCourt >= 2) starBonus += 3;
                    });

                    const avgDefense = totalDefense / rotations.length;
                    const thresholdPercent = aboveThresholdCount / rotations.length;
                    const score = (servingScore * 1.0) + (avgDefense * 2) + (thresholdPercent * 50) + starBonus;

                    allLineups.push({
                        positions: testPositions,
                        score: score,
                        thresholdPercent: thresholdPercent,
                        avgDefense: avgDefense,
                        servingScore: servingScore,
                        starBonus: starBonus
                    });
                }

                allLineups.sort((a, b) => b.score - a.score);
                const topLineups = allLineups.slice(0, 10);
                
                setBestLineups(topLineups);
                setCurrentLineupIndex(0);

                if (topLineups.length > 0) {
                    setCourtPositions(topLineups[0].positions);
                }
                
                setIsOptimizing(false);
            };

            const shuffleStandardPlay = () => {
                if (bestLineups.length === 0) return;
                
                const nextIndex = (currentLineupIndex + 1) % bestLineups.length;
                setCurrentLineupIndex(nextIndex);
                setCourtPositions(bestLineups[nextIndex].positions);
            };

            const autoArrangePlayers = () => {
                const activePlayers = players.filter(p => p.active);
                if (activePlayers.length < 6) return;

                const newPositions = {
                    backLeft: activePlayers.find(p => p.name === '1') || activePlayers[0],
                    frontLeft: activePlayers.find(p => p.name === '2') || activePlayers[1],
                    frontMiddle: activePlayers.find(p => p.name === '3') || activePlayers[2],
                    frontRight: activePlayers.find(p => p.name === '4') || activePlayers[3],
                    backRight: activePlayers.find(p => p.name === '5') || activePlayers[4],
                    backMiddle: activePlayers.find(p => p.name === '6') || activePlayers[5],
                    bench: activePlayers.slice(6)
                };
                setCourtPositions(newPositions);
            };

            const rotateForward = () => {
                const courtPlayers = [
                    courtPositions.backLeft,
                    courtPositions.backMiddle,
                    courtPositions.backRight,
                    courtPositions.frontLeft,
                    courtPositions.frontMiddle,
                    courtPositions.frontRight
                ].filter(Boolean);
                
                if (courtPlayers.length < 6) return;

                const newPositions = {
                    backRight: courtPositions.backMiddle,
                    frontRight: courtPositions.backRight,
                    frontMiddle: courtPositions.frontRight,
                    frontLeft: courtPositions.frontMiddle,
                    backLeft: courtPositions.frontLeft,
                    bench: [...courtPositions.bench]
                };

                const newBench = [...courtPositions.bench];
                newBench.push(courtPositions.backLeft);
                
                if (newBench.length > 0) {
                    newPositions.backMiddle = newBench.shift();
                }
                
                newPositions.bench = newBench;
                setCourtPositions(newPositions);
            };

            const exportData = () => {
                const data = {
                    players,
                    teamName,
                    minThreshold,
                    courtPositions,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `volleyball_team_${teamName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.players) setPlayers(importedData.players);
                        if (importedData.teamName) setTeamName(importedData.teamName);
                        if (importedData.minThreshold) setMinThreshold(importedData.minThreshold);
                        if (importedData.courtPositions) setCourtPositions(importedData.courtPositions);
                        
                        alert('Team data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleDragStart = (e, player) => {
                setDraggedPlayer(player);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDragEnter = (e, zone) => {
                e.preventDefault();
                setDropZone(zone);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setDropZone(null);
            };

            const handleDrop = (e, targetPosition) => {
                e.preventDefault();
                if (!draggedPlayer) return;

                const newPositions = { ...courtPositions };
                
                let currentPosition = null;
                Object.keys(newPositions).forEach(pos => {
                    if (pos === 'bench') {
                        const benchIndex = newPositions[pos].findIndex(p => p.id === draggedPlayer.id);
                        if (benchIndex >= 0) {
                            currentPosition = { type: 'bench', index: benchIndex };
                        }
                    } else if (newPositions[pos] && newPositions[pos].id === draggedPlayer.id) {
                        currentPosition = { type: 'court', position: pos };
                    }
                });

                if (currentPosition) {
                    if (currentPosition.type === 'bench') {
                        newPositions.bench.splice(currentPosition.index, 1);
                    } else {
                        newPositions[currentPosition.position] = null;
                    }
                }

                if (targetPosition === 'bench') {
                    newPositions.bench.push(draggedPlayer);
                } else if (targetPosition.startsWith('bench-')) {
                    const index = parseInt(targetPosition.split('-')[1]);
                    newPositions.bench.splice(index, 0, draggedPlayer);
                } else {
                    if (newPositions[targetPosition]) {
                        if (currentPosition && currentPosition.type === 'court') {
                            newPositions[currentPosition.position] = newPositions[targetPosition];
                        } else if (currentPosition && currentPosition.type === 'bench') {
                            newPositions.bench.splice(currentPosition.index, 0, newPositions[targetPosition]);
                        }
                    }
                    newPositions[targetPosition] = draggedPlayer;
                }

                setCourtPositions(newPositions);
                setDraggedPlayer(null);
                setDropZone(null);
            };

            const currentStrengths = calculateRotationStrengths(courtPositions).slice(0, 6); = newBench;
                setCourtPositions(newPositions);
            };

            const rotateBackward = () => {
                const courtPlayers = [
                    courtPositions.backLeft,
                    courtPositions.backMiddle,
                    courtPositions.backRight,
                    courtPositions.frontLeft,
                    courtPositions.frontMiddle,
                    courtPositions.frontRight
                ].filter(Boolean);
                
                if (courtPlayers.length < 6) return;

                const newPositions = {
                    frontLeft: courtPositions.backLeft,
                    frontMiddle: courtPositions.frontLeft,
                    frontRight: courtPositions.frontMiddle,
                    backRight: courtPositions.frontRight,
                    backMiddle: courtPositions.backRight,
                    bench: [...courtPositions.bench]
                };

                const newBench = [...courtPositions.bench];
                newBench.unshift(courtPositions.backMiddle);
                
                if (newBench.length > 0) {
                    newPositions.backLeft = newBench.pop();
                }
                
                newPositions.bench
const PlayerTile = ({ player, position, isOnCourt, benchIndex }) => (
                React.createElement('div', {
                    className: `p-3 rounded-lg shadow-md cursor-pointer transition-all ${
                        player.active 
                            ? (isOnCourt ? 'bg-blue-100 border-2 border-blue-500' : 'bg-green-100 border-2 border-green-400')
                            : 'bg-gray-200 border-2 border-gray-300'
                    } ${player.star ? 'star-player' : ''} ${draggedPlayer && draggedPlayer.id === player.id ? 'dragging' : ''}`,
                    draggable: true,
                    onDragStart: (e) => handleDragStart(e, player),
                    onClick: () => handleEditPlayer(player)
                },
                    React.createElement('div', { className: "flex items-center justify-between" },
                        React.createElement('div', { className: "font-semibold text-sm" }, player.name),
                        player.star && React.createElement('span', { className: "text-yellow-500 text-sm" }, 'â­')
                    ),
                    position && React.createElement('div', { className: "text-xs text-gray-600 mt-1" }, position)
                )
            );

            const DropZone = ({ position, currentPlayer, label }) => (
                React.createElement('div', {
                    className: `h-16 border-2 border-dashed rounded-lg flex items-center justify-center transition-all ${
                        dropZone === position ? 'drop-zone-active' : 'border-gray-300'
                    }`,
                    onDragOver: handleDragOver,
                    onDragEnter: (e) => handleDragEnter(e, position),
                    onDragLeave: handleDragLeave,
                    onDrop: (e) => handleDrop(e, position)
                },
                    currentPlayer ? 
                        React.createElement(PlayerTile, { player: currentPlayer, position: label, isOnCourt: true }) :
                        React.createElement('span', { className: "text-xs text-gray-400" }, "Empty")
                )
            );

            const CourtDisplay = () => (
                React.createElement('div', { className: "bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-6" },
                    React.createElement('div', { className: "text-center text-sm font-semibold mb-4 text-orange-800" },
                        `${teamName} - Court Layout`
                    ),
                    
                    currentStrengths.length > 0 && (
                        React.createElement('div', { className: "mb-4 p-3 bg-white rounded-lg border" },
                            React.createElement('div', { className: "text-xs font-semibold mb-2 text-center" }, 
                                "Row Totals (Defense) - Min: " + minThreshold
                            ),
                            React.createElement('div', { className: "flex justify-between text-xs mb-2" },
                                React.createElement('div', {}, 
                                    `Front: ${currentStrengths[0]?.frontRowTotal || 0}`,
                                    React.createElement('span', { 
                                        className: `ml-1 ${(currentStrengths[0]?.frontRowTotal || 0) >= minThreshold ? 'text-green-600' : 'text-red-600'}`
                                    }, (currentStrengths[0]?.frontRowTotal || 0) >= minThreshold ? 'âœ“' : 'âœ—')
                                ),
                                React.createElement('div', {}, 
                                    `Back: ${currentStrengths[0]?.backRowTotal || 0}`,
                                    React.createElement('span', { 
                                        className: `ml-1 ${(currentStrengths[0]?.backRowTotal || 0) >= minThreshold ? 'text-green-600' : 'text-red-600'}`
                                    }, (currentStrengths[0]?.backRowTotal || 0) >= minThreshold ? 'âœ“' : 'âœ—')
                                )
                            ),
                            bestLineups.length > 0 && (
                                React.createElement('div', { className: "text-xs text-center text-gray-600" },
                                    `Lineup ${currentLineupIndex + 1} of ${bestLineups.length} best options`
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "border-b-2 border-dashed border-orange-400 pb-3 mb-3" },
                        React.createElement('div', { className: "text-xs text-center mb-2 text-orange-700" }, "Back Row (20 ft)"),
                        React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Left (Serve)"),
                                React.createElement(DropZone, { 
                                    position: "backLeft", 
                                    currentPlayer: courtPositions.backLeft, 
                                    label: "BL" 
                                })
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Middle"),
                                React.createElement(DropZone, { 
                                    position: "backMiddle", 
                                    currentPlayer: courtPositions.backMiddle, 
                                    label: "BM" 
                                })
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Right"),
                                React.createElement(DropZone, { 
                                    position: "backRight", 
                                    currentPlayer: courtPositions.backRight, 
                                    label: "BR" 
                                })
                            )
                        )
                    ),

                    React.createElement('div', { className: "border-b-2 border-dashed border-orange-400 pb-3 mb-3" },
                        React.createElement('div', { className: "text-xs text-center mb-2 text-orange-700" }, "Front Row (10 ft)"),
                        React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Left"),
                                React.createElement(DropZone, { 
                                    position: "frontLeft", 
                                    currentPlayer: courtPositions.frontLeft, 
                                    label: "FL" 
                                })
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Middle"),
                                React.createElement(DropZone, { 
                                    position: "frontMiddle", 
                                    currentPlayer: courtPositions.frontMiddle, 
                                    label: "FM" 
                                })
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs mb-1" }, "Right"),
                                React.createElement(DropZone, { 
                                    position: "frontRight", 
                                    currentPlayer: courtPositions.frontRight, 
                                    label: "FR" 
                                })
                            )
                        )
                    ),

                    React.createElement('div', { className: "w-full h-2 bg-black mb-4 rounded" }),

                    React.createElement('div', { className: "flex justify-center gap-4 mb-4" },
                        React.createElement('button', {
                            onClick: rotateBackward,
                            className: "flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",
                            disabled: [courtPositions.backLeft, courtPositions.backMiddle, courtPositions.backRight, courtPositions.frontLeft, courtPositions.frontMiddle, courtPositions.frontRight].filter(Boolean).length < 6
                        },
                            "âŸ² Previous"
                        ),
                        React.createElement('button', {
                            onClick: rotateForward,
                            className: "flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",
                            disabled: [courtPositions.backLeft, courtPositions.backMiddle, courtPositions.backRight, courtPositions.frontLeft, courtPositions.frontMiddle, courtPositions.frontRight].filter(Boolean).length < 6
                        },
                            "Next âŸ³"
                        )
                    )
                )
            );

            const BenchDisplay = () => (
                React.createElement('div', { 
                    className: "bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-6",
                    onDragOver: handleDragOver,
                    onDragEnter: (e) => handleDragEnter(e, 'bench'),
                    onDragLeave: handleDragLeave,
                    onDrop: (e) => handleDrop(e, 'bench')
                },
                    React.createElement('div', { className: "text-center text-sm font-semibold mb-3 text-green-800" },
                        "Bench Players (Next to rotate in at bottom)"
                    ),
                    React.createElement('div', { className: "space-y-2" },
                        courtPositions.bench.map((player, index) => (
                            React.createElement('div', { key: player.id, className: "flex items-center gap-2" },
                                React.createElement('span', { className: "text-xs w-6 text-center" }, courtPositions.bench.length - index),
                                React.createElement(PlayerTile, { player: player, isOnCourt: false, benchIndex: index })
                            )
                        )),
                        courtPositions.bench.length === 0 && (
                            React.createElement('div', { className: "text-center text-gray-500 text-sm" }, "No bench players")
                        )
                    )
                )
            );

            return React.createElement('div', { className: "max-w-md mx-auto bg-white min-h-screen p-4" },
                // PWA Install Prompt
                showInstallPrompt && (
                    React.createElement('div', { className: "install-prompt mb-4 p-4 text-white rounded-lg flex items-center justify-between" },
                        React.createElement('div', {},
                            React.createElement('div', { className: "font-semibold text-sm" }, "Install Volleyball App"),
                            React.createElement('div', { className: "text-xs opacity-90" }, "Add to home screen for offline use")
                        ),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('button', {
                                onClick: () => setShowInstallPrompt(false),
                                className: "px-3 py-1 bg-white bg-opacity-20 rounded text-xs"
                            }, "Later"),
                            React.createElement('button', {
                                onClick: handleInstallClick,
                                className: "px-3 py-1 bg-white text-purple-600 rounded text-xs font-semibold"
                            }, "Install")
                        )
                    )
                ),

                // Header with enhanced save functionality
                React.createElement('div', { className: "flex items-center justify-between mb-6" },
                    React.createElement('input', {
                        type: "text",
                        value: teamName,
                        onChange: (e) => setTeamName(e.target.value),
                        className: "text-lg font-bold bg-transparent border-b-2 border-gray-300 focus:border-blue-500 outline-none"
                    }),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('button', { 
                            onClick: exportData,
                            className: "p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600",
                            title: "Export team data"
                        },
                            "ðŸ’¾"
                        ),
                        React.createElement('label', { 
                            className: "p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer",
                            title: "Import team data"
                        },
                            "ðŸ“‚",
                            React.createElement('input', {
                                type: "file",
                                accept: ".json",
                                onChange: handleImportData,
                                className: "hidden"
                            })
                        )
                    )
                ),

                // Star Player Status
                React.createElement('div', { className: "mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg" },
                    React.createElement('div', { className: "text-sm font-medium text-yellow-800 mb-1" },
                        `Star Players: ${players.filter(p => p.star).length}/3`
                    ),
                    React.createElement('div', { className: "text-xs text-yellow-700" },
                        "â­ Select up to 3 star players. Algorithms ensure 1+ star always on court, prefer 2, and prevent adjacent positioning."
                    )
                ),

                // Court Display
                React.createElement(CourtDisplay),
                
                // Bench Display
                React.createElement(BenchDisplay),

                // Optimization Controls
                React.createElement('div', { className: "mb-4 p-4 bg-gray-50 rounded-lg" },
                    React.createElement('div', { className: "mb-3" },
                        React.createElement('label', { className: "block text-sm font-medium mb-1" }, 
                            `Minimum Row Total: ${minThreshold}`
                        ),
                        React.createElement('input', {
                            type: "range",
                            min: "3",
                            max: "15",
                            value: minThreshold,
                            onChange: (e) => setMinThreshold(parseInt(e.target.value)),
                            className: "w-full"
                        }),
                        React.createElement('div', { className: "flex justify-between text-xs text-gray-500 mt-1" },
                            React.createElement('span', {}, "3"),
                            React.createElement('span', {}, "15")
                        )
                    ),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('button', {
                            onClick: optimizeStandardPlay,
                            className: `flex-1 p-3 text-white rounded-lg transition-colors ${
                                isOptimizing ? 'optimizing cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600'
                            }`,
                            disabled: isOptimizing || players.filter(p => p.active).length < 6
                        },
                            isOptimizing ? "Optimizing..." : "ðŸŽ¯ Standard Play"
                        ),
                        React.createElement('button', {
                            onClick: optimizeServingPriority,
                            className: `flex-1 p-3 text-white rounded-lg transition-colors ${
                                isOptimizing ? 'optimizing cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'
                            }`,
                            disabled: isOptimizing || players.filter(p => p.active).length < 6
                        },
                            isOptimizing ? "Optimizing..." : "âš¡ Serving Priority"
                        ),
                        React.createElement('button', {
                            onClick: shuffleStandardPlay,
                            className: "px-3 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400",
                            disabled: bestLineups.length === 0,
                            title: "Shuffle through best lineups"
                        },
                            "ðŸ”€"
                        )
                    ),
                    React.createElement('div', { className: "flex gap-2 mt-2" },
                        React.createElement('button', {
                            onClick: autoArrangePlayers,
                            className: "flex-1 p-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors",
                            disabled: players.filter(p => p.active).length < 6
                        },
                            "ðŸ“‹ Basic Setup"
                        )
                    )
                ),

                // Players List
                React.createElement('div', { className: "mb-6" },
                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                        React.createElement('h2', { className: "text-lg font-semibold" }, `Team Roster (${players.length}/10)`),
                        React.createElement('button', {
                            onClick: () => setShowPlayerForm(true),
                            className: "flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                        },
                            "+ Add Player"
                        )
                    ),
                    
                    React.createElement('div', { className: "space-y-2" },
                        players.map(player => (
                            React.createElement('div', { key: player.id, className: "flex items-center gap-3" },
                                React.createElement('button', {
                                    onClick: () => togglePlayerActive(player.id),
                                    className: `w-4 h-4 rounded border-2 ${
                                        player.active ? 'bg-green-500 border-green-500' : 'border-gray-300'
                                    }`
                                }),
                                React.createElement('button', {
                                    onClick: () => togglePlayerStar(player.id),
                                    className: `w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                        player.star ? 'bg-yellow-400 border-yellow-500' : 'border-gray-300 hover:border-yellow-400'
                                    } ${players.filter(p => p.star).length >= 3 && !player.star ? 'opacity-50 cursor-not-allowed' : ''}`,
                                    disabled: players.filter(p => p.star).length >= 3 && !player.star
                                },
                                    React.createElement('span', { className: "text-xs" }, player.star ? 'â­' : 'â˜†')
                                ),
                                React.createElement(PlayerTile, { player: player, isOnCourt: false }),
                                React.createElement('div', { className: "text-xs text-gray-600" },
                                    `D:${player.defense} S:${player.serving}`
                                )
                            )
                        ))
                    )
                ),

                // Player Form Modal
                showPlayerForm && (
                    React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                        React.createElement('div', { className: "bg-white rounded-lg p-6 w-80 mx-4" },
                            React.createElement('h3', { className: "text-lg font-semibold mb-4" },
                                editingPlayer ? 'Edit Player' : 'Add New Player'
                            ),
                            
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Player Name"),
                                    React.createElement('input', {
                                        type: "text",
                                        value: playerForm.name,
                                        onChange: (e) => setPlayerForm({...playerForm, name: e.target.value}),
                                        className: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",
                                        placeholder: "Enter player name"
                                    })
                                ),
                                
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Defense Rating (1-5)"),
                                    React.createElement('input', {
                                        type: "range",
                                        min: "1",
                                        max: "5",
                                        value: playerForm.defense,
                                        onChange: (e) => setPlayerForm({...playerForm, defense: parseInt(e.target.value)}),
                                        className: "w-full"
                                    }),
                                    React.createElement('div', { className: "text-center font-semibold" }, playerForm.defense)
                                ),
                                
                                React.createElement('div', {},
                                    React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Serving Rating (1-5)"),
                                    React.createElement('input', {
                                        type: "range",
                                        min: "1",
                                        max: "5",
                                        value: playerForm.serving,
                                        onChange: (e) => setPlayerForm({...playerForm, serving: parseInt(e.target.value)}),
                                        className: "w-full"
                                    }),
                                    React.createElement('div', { className: "text-center font-semibold" }, playerForm.serving)
                                ),

                                React.createElement('div', { className: "flex items-center gap-2" },
                                    React.createElement('label', { className: "block text-sm font-medium" }, "Star Player"),
                                    React.createElement('button', {
                                        onClick: () => setPlayerForm({...playerForm, star: !playerForm.star}),
                                        className: `w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                            playerForm.star ? 'bg-yellow-400 border-yellow-500' : 'border-gray-300 hover:border-yellow-400'
                                        }`,
                                        type: "button"
                                    },
                                        React.createElement('span', { className: "text-xs" }, playerForm.star ? 'â­' : 'â˜†')
                                    )
                                )
                            ),
                            
                            React.createElement('div', { className: "flex gap-3 mt-6" },
                                React.createElement('button', {
                                    onClick: () => {
                                        setShowPlayerForm(false);
                                        setEditingPlayer(null);
                                        setPlayerForm({ name: '', defense: 3, serving: 3, active: true, star: false });
                                    },
                                    className: "flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                }, "Cancel"),
                                React.createElement('button', {
                                    onClick: editingPlayer ? handleUpdatePlayer : handleAddPlayer,
                                    className: "flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600",
                                    disabled: !playerForm.name.trim()
                                }, editingPlayer ? 'Update Player' : 'Add Player')
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(VolleyballApp), document.getElementById('root'));
    </script>
</body>
</html>
